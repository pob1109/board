<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 수정폼</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<style>
    .layout{
        width:500px;
        margin:0 auto;
        margin-top: 40px;
    }

    .layout input{
        width:100%;
        box-sizing:border-box;
    }

    .layout textarea{
        width:100%;
        margin-top:10px;
        min-height: 300px;
    }
</style>

<body>
    <header id="header"></header>
    <div class="layout">
        <form id="updateForm" method="post">
            <input id="title" type="text" required placeholder="제목을 입력하세요">
            <textarea id="content" type="text" required placeholder="내용을 입력하세요"></textarea>
            <button type="submit">수정</button>
        </form>
    </div>
    <script>
        fetch('/header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header').innerHTML = data;
                // header.html 내의 스크립트 실행
                const scripts = document.getElementById('header').getElementsByTagName('script');
                for (let script of scripts) {
                    eval(script.textContent);  // 스크립트 실행
                }
            })
            .catch(error => console.error('Error loading header:', error));

        //로그인 체크
        const token = sessionStorage.getItem("authToken");
        if (!token){
            window.location.href = '/login';
            alert("로그인 후에 사용할 수 있는 기능입니다.");
        }
        
        // 현재 게시물 ID를 URL에서 추출
        const postId = window.location.pathname.split('/').pop(); // URL에서 postId 추출

        async function fetchPostData(){
            try {
                // 게시물 데이터 가져오기
                const postData = await (await fetch(`/api/board/post/${postId}`)).json();
                
                // 사용자 이메일 확인 및 권한 검사
                const tokenEmail = await (await fetch(`/api/user/tokenToEmail`, {
                    method: 'POST',
                    headers: { 'authorization': token },
                })).json();

                if (tokenEmail !== postData.email) {
                    window.history.back();
                    alert('게시글 수정에 대한 권한이 없습니다.');
                }
                
                document.getElementById('title').value = postData.title;
                document.getElementById('content').value = postData.content;
            } catch (error) {
                console.error('오류 발생:', error);
            }
        };

        // 폼 제출 이벤트 처리
        document.getElementById('updateForm').addEventListener('submit', function(event) {
            event.preventDefault(); // 기본 제출 동작 방지

            const updatedTitle = document.getElementById('title').value;
            const updatedContent = document.getElementById('content').value;

            // API 호출로 수정된 데이터를 전송
            fetch(`/api/board/${postId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: updatedTitle,
                    content: updatedContent
                })
            })
            .then(res => {
                if (res.status === 200) {
                    alert('게시물이 성공적으로 수정되었습니다.');
                    window.location.href = '/list'
                } else {
                    alert('게시물 수정에 실패했습니다.');
                }
            })
            .catch(error => console.error('Error:', error))
        });

        fetchPostData();
    </script>
</body>
</html>